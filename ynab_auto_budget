#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ynab_auto_budget

Uses a budget template and the You Need a Budget (YNAB) API to suggest monthy
budget amounts. The YNAB currently does not support writing monthly budget
amounts, so that must be done manually.
"""

import sys
import os
import argparse
import json

import ynab
import yaml


class YNABAutoBudgetError(Exception):
    """ Used for exceptions specific to this script """

    pass


def setup_ynab(credentials_filename):
    """ Get the user's credentials """

    configuration = ynab.Configuration()

    try:
        with open(os.path.expanduser(credentials_filename)) as cfile:
            credentials = json.load(cfile)

        configuration.api_key['Authorization'] = credentials['key']
        configuration.api_key_prefix['Authorization'] = credentials['prefix']
    except IOError as err:
        raise YNABAutoBudgetError('Unable to open credentials file:\n{}'\
                                  .format(err))
    except json.JSONDecodeError:
        raise YNABAutoBudgetError('Unable to parse credentials file {}'\
                                  .format(credentials_filename))
    except KeyError as err:
        raise YNABAutoBudgetError('Expected key {} not found in credentials '\
                                  'file {}'.format(err, credentials_filename))

    return configuration


def get_ynab_budget_id(configuration, name):
    """ Get the API id for the named budget """

    api = ynab.BudgetsApi()

    try:
        budget_summary = api.get_budgets()
    except ynab.rest.ApiException as err:
        raise YNABAutoBudgetError('YNAB API error:\n{}'.format(err))

    # Find the named budget and retur the ID
    for budget in budget_summary.data.budgets:
        if budget.name == name:
            return budget.id

    # If we get here, the budget wasn't found
    raise YNABAutoBudgetError("Budget '{}' not found")


def get_ynab_budget_categories(configuration):
    """ Get the catagory names from the budget """

    budget_id = get_ynab_budget_id(configuration, 'My Budget')

    api = ynab.CategoriesApi()

    try:
        categories_response = api.get_categories(budget_id)
    except ynab.rest.ApiException as err:
        raise YNABAutoBudgetError('YNAB API error:\n{}'.format(err))

    return categories_response.data.category_groups


def create_empty_template(groups, filename):
    """ Create an empty template file """

    if os.path.exists(filename):
        raise YNABAutoBudgetError('--create will not overwrite an existing file')

    template = {'remainder': None, 'categories': []}

    for group in groups:
        for category in group.categories:
            if not category.hidden:
                template['categories'].append({'category': category.name,
                                            'type': 'fixed',
                                            'value': 0})

    try:
        with open(filename,'w') as tfile:
            yaml.dump(template, stream=tfile, default_flow_style=False)
    except IOError as err:
        raise YNABAutoBudgetError(err)


def show_current_values(groups):
    for group in groups:
        #print(group)
        print(group.name)

        for category in group.categories:
            print('  {}: Budgeted {:.2f} Activity {:.2f} Balance {:.2f}'\
                .format(category.name,
                        category.budgeted / 1000.0,
                        category.activity / 1000.0,
                        category.balance / 1000.0))
    
    #print(groups)


def main(arguments):
    """ Get YNAB budget, template, and display results """

    try:
        configuration = setup_ynab(arguments.credentials)

        category_groups = get_ynab_budget_categories(configuration)

        if args.create:
            create_empty_template(category_groups, arguments.template)
        elif args.show:
            show_current_values(category_groups)

    except YNABAutoBudgetError as err:
        print(err)
        return 1

    return 0

if __name__ == '__main__':
    # Parse arguments with argparse
    formatter_class = argparse.ArgumentDefaultsHelpFormatter

    parser = argparse.ArgumentParser(description=__doc__,
                                     formatter_class=formatter_class)

    parser.add_argument('template',
                        help="Budget template file",
                        type=str)

    parser.add_argument('-c', '--credentials',
                        help="YNAB credentials file",
                        default='~/.ynab/ynab_credentials.json',
                        type=str)
    
    parser.add_argument('--create',
                        help='Create empty template',
                        action='store_true')

    parser.add_argument('-s', '--show',
                        help='Show current budgeted values',
                        action='store_true')

    args = parser.parse_args(sys.argv[1:])

    # Call main() with parsed args
    sys.exit(main(args))
